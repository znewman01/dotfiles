#!/usr/bin/env nix-shell
#! nix-shell -p morph -i bash
set -eux

HOST=$1

function main() {
	if [ "$HOST" == "" ]; then
	  echo "Must pass HOST as CLI arg."
	  exit 1
	fi

	cat > assimilate.nix <<-EOF
	{
	  network = { description = "zjn"; };
	  "$HOST" = { config, pkgs, lib, ... }: {
	    imports = [ ../common.nix ../machines/$HOST/system.nix ];
	    deployment.targetUser = "root";
	    deployment.targetHost = "zjn-install.local";
      nix.requireSignedBinaryCaches = false;
	    home-manager.users.zjn = {
	      imports = [ ../home-common.nix ../machines/$HOST/default.nix ];
	    };
	  };
	}
	EOF

	morph build --keep-result assimilate.nix
	morph push ./assimilate.nix
	morph deploy assimilate.nix boot
	morph exec assimilate.nix -- reboot || true

	# rm assimilate.nix
}

main
